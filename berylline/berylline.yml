meta:
  engine: 4.0.0
  name: berylline
  version: 0.3
  author: jcmkk3
  url: https://github.com/jcmkk3/trochilidae

presets:
  # These presets provide different layout options
  # Select a preset in the `units` section below
  # Note: The appropriate switch footprint will still need to be set in the `pcb` section
  choc_spaced:
    capx: 17        # Key cap size horizontal
    capy: 16        # Key cap size vertical
    kx: cx + 0.5    # Key spacing horizontal
    ky: cy + 0.5    # Key spacing vertical
    pinky_splay: 5  # Degrees of splay between pinky and ring columns
    pinky_adj: -3   # Adjustment to compensate for splay spacing
    ring_splay: 3
    ring_adj: -8
    middle_splay: 0
    middle_adj: 0
    thumb_offsetx: 0.25kx
  
  choc_min_spaced:
    capx: 14.5
    capy: 14.5
    kx: 15 + 0.5
    ky: 15 + 0.5
    pinky_splay: 5
    pinky_adj: -3
    ring_splay: 3
    ring_adj: -8
    middle_splay: 3
    middle_adj: -5
    thumb_offsetx: 1/3kx
  
  mx_min_spaced:
    capx: 15.5
    capy: 15.5
    kx: 16 + 0.5
    ky: 16 + 0.5
    pinky_splay: 5
    pinky_adj: -3
    ring_splay: 3
    ring_adj: -8
    middle_splay: 3
    middle_adj: -5
    thumb_offsetx: 1/3kx

units:
  $extends: presets.choc_spaced

  # Defaults/Constants
  # ====================
  $default_height: 0  # Points invisible by default unless height/width explicitly set
  $default_width: 0
  xiao_x: 20
  xiao_y: 17.5

points:
  # Keys/Switches
  # =============
  zones.matrix:
    anchor.shift: [150, -180]
    rotate: pinky_splay + ring_splay + middle_splay
    key:
      width: capx
      height: capy
      spread: kx      
      padding: ky
    rows:
      bottom.key.row_net: P6
      home.key.row_net: P7
      top.key.row_net: P8
    columns:
      pinky:
        key.col_net: P1
        rows.bottom.skip: true
      ring.key:
        stagger: 2/3ky
        splay: -pinky_splay
        origin: [0, pinky_adj]
        col_net: P2
      middle.key:
        stagger: 0.25ky
        splay: -ring_splay
        origin: [0, ring_adj]
        col_net: P3
      index.key:
        stagger: -0.25ky
        splay: -middle_splay
        origin: [0, middle_adj]
        col_net: P4
      inner:
        key:
          stagger: -0.5ky
          col_net: P5
        rows.bottom.skip: true
  zones.thumb:
    anchor:
      ref: matrix_index_bottom
      shift: [thumb_offsetx, -22]
    key:
      $extends: points.zones.matrix.key
      row_net: P6
    columns:
      tucky.key.col_net: P1
      reachy.key:
        stagger: -0.25ky
        col_net: P5

  # Outline Extents
  # ===============
  zones.outline_top_left:
    anchor:
    - ref: matrix_middle_top
      shift: [0.5kx, 0.5ky]
      affect: y
    - ref: matrix_pinky_top
      affect: x
      shift: [-0.5kx, 0.5ky]
  zones.outline_top_right:
    anchor:
    - ref: outline_top_left
    - ref: thumb_reachy
      affect: x
      shift: [0.5kx, -0.5ky]
  zones.outline_bottom_left:
    anchor:
    - ref: outline_top_left
    - ref: thumb_reachy
      affect: y
      shift: [0.5kx, -0.5ky]
  zones.outline_bottom_right:
    anchor:
    - ref: outline_top_right
    - ref: outline_bottom_left
      affect: y

  # Components
  # ==========
  zones.mcu:
    anchor:
    - ref: outline_bottom_right
      shift: [-0.5xiao_x, 0]
      affect: x
    - aggregate.parts:
      - matrix_inner_home
      - thumb_reachy
      affect: y
    key:
      width: xiao_x
      height: xiao_y

outlines:
  panel:
    - what: polygon
      fillet: 3
      points:
      - ref: outline_top_left
      - ref: outline_top_right
      - ref: outline_bottom_right
      - ref: outline_bottom_left
  _mcu:
    - what: rectangle
      where: mcu
      size: [xiao_x, xiao_y]
  _mounting_holes:
    - what: circle
      where: /mounting_hole_.*/
      radius: 1
  _keycaps:
    - what: rectangle
      where:
        - /matrix_.*/
        - /thumb_.*/
      size: [capx, capy]
      bound: false
  key_demo:
    - panel
    - ^_mcu
    - ^_mounting_holes
    - ^_keycaps

pcbs.berylline:
  outlines.main:
    outline: panel
  footprints:
    - what: choc
      where:
        - /matrix_.*/
        - /thumb_.*/
      params:
        from: "{{row_net}}"
        to: "{{col_net}}"
        keycaps: true
    - what: diode
      where: true
      adjust:
        shift: [0, -4.7]
      params:
        from: "{{row_net}}"
        to: "{{colrow}}"
    - what: promicro
      where: mcu
      adjust.rotate: 90
    - what: via
      where: /mounting_hole_.*/
      params.net: ""
    - what: button
      where: reset
      adjust.rotate: 90
      params:
        from: RST
        to: GND
