meta:
  engine: 4.0.0
  name: berylline_choc
  version: 0.1
  author: jcmkk3
  url: https://github.com/jcmkk3/trochilidae

units:
  # Parameters
  # ==========
  capx: 17        # Key cap size horizontal
  capy: 16        # Key cap size vertical
  kx: cx + 0.5    # Key spacing horizontal
  ky: cy + 0.5    # Key spacing vertical
  pinky_splay: 5  # Degrees of splay between pinky and ring columns
  pinky_adj: -3   # Adjustment to compensate for splay spacing
  ring_splay: 3
  ring_adj: -8
  middle_splay: 0
  middle_adj: 0
  thumb_offsetx: 0.25kx

  # Constants
  # =========
  promicro_x: 33
  promicro_y: 18
  sf: 15          # Switch footprint (square)

points:
  key:  # Zero out points so they don't have a size unless explicitly set
    height: 0
    width: 0

  # Keys/Switches
  # =============
  zones.matrix:
    anchor.shift: [150, -180]
    rotate: pinky_splay + ring_splay + middle_splay
    key:
      width: capx
      height: capy
    rows:
      bottom.padding: ky
      home.padding: ky
      top.padding: ky
    columns:
      pinky:
        key.spread: kx
        rows:
          bottom.skip: true
      ring.key:
        spread: kx
        stagger: 2/3ky
        splay: -pinky_splay
        origin: [0, pinky_adj]
      middle.key:
        spread: kx
        stagger: 0.25ky
        splay: -ring_splay
        origin: [0, ring_adj]
      index.key:
        spread: kx
        stagger: -0.25ky
        splay: -middle_splay
        origin: [0, middle_adj]
      inner:
        key:
          spread: kx
          stagger: -0.5ky
        rows:
          bottom.skip: true
  zones.thumb:
    anchor:
      ref: matrix_index_bottom
      shift: [thumb_offsetx, -22]
    key:
      width: capx
      height: capy
    columns:
      tucky:
      reachy.key:
        spread: kx
        stagger: -0.25ky

  # Outline Extents
  # ===============
  zones.outline_top_left:
    anchor:
    - ref: matrix_middle_top
      shift: [0.5sf, 0.5sf]
      affect: y
    - ref: matrix_pinky_top
      affect: x
      shift: [-0.5sf, 0.5sf]
  zones.outline_top_right:
    anchor:
    - ref: outline_top_left
    - ref: thumb_reachy
      affect: x
      shift: [0.5sf, -0.5sf]
  zones.outline_bottom_left:
    anchor:
    - ref: outline_top_left
    - ref: thumb_reachy
      affect: y
      shift: [0.5sf, -0.5sf]
  zones.outline_bottom_right:
    anchor:
    - ref: outline_top_right
    - ref: outline_bottom_left
      affect: y

  # Components
  # ==========
  zones.mcu:
    anchor:
      ref: outline_bottom_left
      shift: [0.5promicro_x, 0.5promicro_y + 3]
    key:
      width: promicro_x
      height: promicro_y
  zones.mounting_hole_top:
    anchor:
      - ref: matrix_pinky_top
        affect: y
        shift: [0, ky / 2 + 4.5]
      - ref: matrix_ring_top
        affect: x
        shift: [-kx / 2 - 2.5, 0]
    key:
      height: 1
      width: 1
  zones.mounting_hole_bottom:
    anchor:
      - ref: matrix_inner_home
        affect: y
        shift: [0, -ky / 2 - 2.5]
      - ref: matrix_index_bottom
        affect: x
        shift: [kx / 2 + 2.5, 0]
    key:
      height: 1
      width: 1

outlines:
  panel:
    - what: polygon
      fillet: 3
      points:
      - ref: outline_top_left
      - ref: outline_top_right
      - ref: outline_bottom_right
      - ref: outline_bottom_left
  _mcu:
    - what: rectangle
      where: mcu
      size: [promicro_x, promicro_y]
  _mounting_holes:
    - what: circle
      where: /mounting_hole_.*/
      radius: 1
  _keycaps:
    - what: rectangle
      where:
        - /matrix_.*/
        - /thumb_.*/
      size: [capx, capy]
      bound: false
  key_demo:
    - panel
    - ^_mcu
    - ^_mounting_holes
    - ^_keycaps

pcbs:
  berylline_choc:
    outlines.main:
      outline: panel
    footprints:
      - what: choc
        where:
          - /matrix_.*/
          - /thumb_.*/
        params:
          from: GND
          to: "{{name}}"
          reverse: true
          keycaps: true
      - what: promicro
        where:
          - ref: mcu
            shift: [1.5, 0]  # Compensate for midpoint being off-center 
        params:
          orientation: up
          P20: matrix_pinky_top
          P14: matrix_ring_top
          P19: matrix_middle_top
          P7: matrix_index_top
          P4: matrix_inner_top
          P21: matrix_pinky_home
          P16: matrix_ring_home
          P18: matrix_middle_home
          P8: matrix_index_home
          P5: matrix_inner_home
          P10: matrix_ring_bottom
          P15: matrix_middle_bottom
          P9: matrix_index_bottom
          P6: thumb_tucky
          P3: thumb_reachy
      - what: via
        where: /mounting_hole_.*/
        params.net: ""
